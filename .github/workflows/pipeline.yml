name: Pipeline CI-CD Equipe

on:
  push:
    branches: [ main ] # Déclenchement automatique sur push
  pull_request:
    branches: [ main ] # Déclenchement sur PR

jobs:
  # PARTIE 2: Job sur runner local
  job-local:
    runs-on: self-hosted
    steps:
      - name: Preuve executeur local
        run: echo "Ce job tourne sur mon PC !"

  # PARTIE 4 & 6: Tests en parallèle
  test-unitaire:
    needs: job-local
    runs-on: ubuntu-latest
    steps:
      - name: Run Unit Test
        run: echo "Test unitaire OK" # Valide un composant isole
      
      # PARTIE 5: Creation Artefact
      - name: Create Report
        run: echo "Rapport de test genere le $(date)" > rapport.txt
      - uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: rapport.txt
          retention-days: 5 # Duree de conservation definie

  test-integration:
    needs: job-local
    runs-on: ubuntu-latest
    steps:
      - name: Run Integration Test
        run: echo "Test integration OK" # Valide interaction entre elements

  # PARTIE 5: Reutilisation Artefact
  analyse:
    needs: test-unitaire
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: test-results
      - name: Use Artifact
        run: cat rapport.txt # Le job B utilise l'artefact du job A

  # PARTIE 3 & 7: Secrets et Build Environnements
  build:
    needs: [test-unitaire, test-integration]
    strategy:
      matrix:
        environment: [staging, production] # Au moins 2 environnements
    runs-on: ubuntu-latest
    env:
      APP_CONFIG: "V1.0-Stable" # Variable non sensible
      MY_SECRET: ${{ secrets.MY_DB_PASSWORD }} # Secret protege
    steps:
      - name: Build Proof
        run: |
          echo "Variable config : $APP_CONFIG"
          echo "Secret (doit etre masque) : $MY_SECRET" # Ne doit jamais apparaitre en clair
          echo "Build pour l'environnement : ${{ matrix.environment }}" > build.log
      
      # PARTIE 7: Artefact associe au build
      - uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.environment }}
          path: build.log